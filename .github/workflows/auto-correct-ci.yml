name: Auto-Correct CI

on:
  workflow_run:
    workflows: ["Skill Validation CI", "Validate Skills"]
    types:
      - completed
  push:
    branches: [main]  # For testing purposes

jobs:
  auto-correct:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync

       - name: Install GitHub CLI
         run: |
           curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
           echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
           sudo apt update
           sudo apt install gh

       - name: Authenticate GitHub CLI
         run: |
           gh auth login --with-token <<< ${{ github.token }}

      - name: Run Auto-Correct (Attempt 1)
        id: attempt1
        run: |
          python3 dev-workflow/scripts/auto_correct_ci.py --workflow "${{ github.event.workflow_run.name }}" --commit ${{ github.event.workflow_run.head_sha }}
        continue-on-error: true

      - name: Check if Fixed
        id: check1
        run: |
          if [ "${{ steps.attempt1.outcome }}" == "success" ]; then
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Auto-Correct (Attempt 2)
        if: steps.check1.outputs.fixed == 'false'
        id: attempt2
        run: |
          python3 dev-workflow/scripts/auto_correct_ci.py --workflow "${{ github.event.workflow_run.name }}" --commit ${{ github.event.workflow_run.head_sha }}
        continue-on-error: true

      - name: Check if Fixed
        id: check2
        if: steps.check1.outputs.fixed == 'false'
        run: |
          if [ "${{ steps.attempt2.outcome }}" == "success" ]; then
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Auto-Correct (Attempt 3)
        if: steps.check2.outputs.fixed == 'false'
        id: attempt3
        run: |
          python3 dev-workflow/scripts/auto_correct_ci.py --workflow "${{ github.event.workflow_run.name }}" --commit ${{ github.event.workflow_run.head_sha }}
        continue-on-error: true

      - name: Notify on Failure After 3 Attempts
        if: steps.check2.outputs.fixed == 'false' && steps.attempt3.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'CI Auto-Correct Failed After 3 Attempts',
              body: 'The CI workflow ${{ github.event.workflow_run.name }} failed and auto-correction did not succeed after 3 attempts. Manual intervention required.\n\nCommit: ${{ github.event.workflow_run.head_sha }}\n\nWorkflow Run: ${{ github.event.workflow_run.html_url }}',
              assignees: [context.actor]
            })