name: OpenCode Integration Pipeline

on:
  push:
    branches: [ feature/opencode-proactive-skill-loader ]
  pull_request:
    branches: [ feature/opencode-proactive-skill-loader ]
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target OpenCode repository URL'
        required: false
        default: 'https://github.com/opencode-ai/opencode'
      skip_ci:
        description: 'Skip CI validation'
        type: boolean
        default: false
      auto_merge:
        description: 'Auto-merge PR after approvals'
        type: boolean
        default: false

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PYTHON_VERSION: '3.12'

jobs:
  integration:
    name: OpenCode Integration
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pydantic requests pyyaml

    - name: Validate files
      run: |
        required_files=("types/proactive-loader.ts" "types/skill-modified.ts" "types/config-modified.ts" "types/session-modified.ts" "OPENCODE_PR_README.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing $file"
            exit 1
          fi
        done
        echo "✅ All files present"

    - name: Run integration
      run: |
        cd opencode-integration-manager
        python scripts/run_integration.py --config ../config/opencode_config.json --target-repo https://github.com/opencode-ai/opencode --changes-dir ../types --auto-commit --create-pr